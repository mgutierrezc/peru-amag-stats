summarise(date_bar_association = first(date_bar_association)) %>%
mutate(participant_years_bar_assoc = 2020 - year(date_bar_association)) %>%
select(nrodocumento, participant_years_bar_assoc)
# Criminal court or criminal prosecutors
criminal_court_id <- participant_data %>%
filter(!is.na(nombre_despacho)) %>%
filter(institucion == "Poder Judicial") %>%
mutate(
nombre_despacho = tolower(nombre_despacho),
participant_criminal_court = if_else(str_detect(nombre_despacho, "penal|preparatoria"), 1, 0)) %>%
group_by(nrodocumento) %>%
summarise(participant_criminal_court = first(participant_criminal_court)) %>%
select(nrodocumento, participant_criminal_court)
criminal_prosecutor_id <- participant_data %>%
filter(!is.na(nombre_despacho)) %>%
filter(institucion == "Ministerio PÃºblico") %>%
mutate(
nombre_despacho = tolower(nombre_despacho),
participant_criminal_prosecutor = if_else(str_detect(nombre_despacho, "penal"),1, 0)) %>%
group_by(nrodocumento) %>%
summarise(participant_criminal_prosecutor = first(participant_criminal_prosecutor)) %>%
select(nrodocumento, participant_criminal_prosecutor)
# Names
names_id <- participant_data %>%
filter(!is.na(nombres)) %>%
select(nrodocumento, round, nombres) %>%
group_by(nrodocumento) %>%
summarise(nombres = first(nombres))
# Apellido materno
apellido_materno_id <- participant_data %>%
filter(!is.na(apellido_materno)) %>%
select(nrodocumento, round, apellido_materno) %>%
group_by(nrodocumento) %>%
summarise(apellido_materno = first(apellido_materno))
# Apellido paterno
apellido_paterno_id <- participant_data %>%
filter(!is.na(apellido_paterno)) %>%
select(nrodocumento, round, apellido_paterno) %>%
group_by(nrodocumento) %>%
summarise(apellido_paterno = first(apellido_paterno))
# Join datasets
pca22_students <- rounds_id %>%
left_join(aula_id, by = "nrodocumento") %>%
left_join(nivel_id, by = "nrodocumento")  %>%
left_join(institucion_id, by = "nrodocumento") %>%
left_join(gender_id, by = "nrodocumento") %>%
left_join(age_id, by = "nrodocumento") %>%
left_join(years_tenure_id, by = "nrodocumento") %>%
left_join(years_bar_association_id, by = "nrodocumento") %>%
left_join(criminal_court_id, by = "nrodocumento") %>%
left_join(criminal_prosecutor_id, by = "nrodocumento") %>%
left_join(names_id, by = "nrodocumento") %>%
left_join(apellido_materno_id, by = "nrodocumento") %>%
left_join(apellido_paterno_id, by = "nrodocumento")
# Fill missing gender
pca22_students <- pca22_students %>%
mutate(participant_female = case_when(
nombres == "VERONICA MARILYN" ~ 1,
nombres == "LEONOR" ~ 1,
nombres == "ROBERTO GERARDO" ~ 0,
nombres == "JAVIER OCTAVIO" ~ 0,
nombres == "ROBERT LUIS" ~ 0,
nombres == "MARINO" ~ 0,
nombres == "ESTHER" ~ 1,
nombres == "ESTANISLAO" ~ 0,
nombres == "SANDRA ARTEMIA" ~ 1,
nombres == "JENNIFER MILDRED" ~ 1,
nombres == "CANCIA" ~ 1,
nombres == "ALBA PAMELA" ~ 1,
nombres == "ALDO ATILANO" ~ 0,
nombres == "SOLEDAD" ~ 1,
nombres == "VICTOR RAUL" ~ 0,
nombres == "CONNIE CATHERINE" ~ 1,
nombres == "VICTOR DANIEL" ~ 0,
nombres == "HECTOR MANUEL" ~ 0,
nombres == "DIANA BEATRIZ" ~ 1,
TRUE ~ participant_female))
# Create master dataset - participant level -----------------------------------
masterdata_participant <- pca22_students %>%
# Join with randomization in round 1
left_join(randomization_round_1, by = c("aula_round1" = "aula_rand1")) %>%
# Join with monitoring assignment for each round
left_join(monitoring_assign_round1, by = "aula_round1") %>%
left_join(monitoring_assign_round2, by = "aula_round2") %>%
left_join(monitoring_assign_round3, by = "aula_round3") %>%
left_join(monitoring_assign_round4, by = "aula_round4") %>%
left_join(monitoring_assign_round5, by = "aula_round5") %>%
left_join(monitoring_assign_round6, by = "aula_round6") %>%
left_join(monitoring_assign_round7, by = "aula_round7") %>%
left_join(monitoring_assign_round8, by = "aula_round8") %>%
left_join(monitoring_assign_round9, by = "aula_round9") %>%
# Join with HR data
# left_join(hr_data, by = "nrodocumento") %>%
# Create full name variable (nombre - apellido)
unite(
participant_nombre_apellido,
c("nombres", "apellido_paterno", "apellido_materno"),
remove = FALSE, sep = " ") %>%
# Create full name variable (apellido - nombre)
unite(participant_apellido_nombre,
c("apellido_paterno", "apellido_materno", "nombres"),
sep = " ") %>%
rowwise() %>%
# Create treatments
mutate(
n_treatment = sum(c_across(monitoreo_round1:monitoreo_round9), na.rm = TRUE),
n_participation = sum(c_across(participation_round1:participation_round9), na.rm = TRUE),
percent_monit = n_treatment / n_participation,
ever_treated = if_else(!percent_monit == 0, 1, 0),
always_treated = if_else(percent_monit == 1, 1, 0),
always_treated_never_treated = case_when(
percent_monit == 1 ~ 1,
percent_monit == 0 ~ 0),
treated_40 = if_else(percent_monit >= 0.4, 1, 0),
treated_50 = if_else(percent_monit >= 0.5, 1, 0),
treated_60 = if_else(percent_monit >= 0.6, 1, 0),
treated_70 = if_else(percent_monit >= 0.7, 1, 0),
treated_80 = if_else(percent_monit >= 0.8, 1, 0),
treated_90 = if_else(percent_monit >= 0.9, 1, 0))
# Create master dataset (Participant-round level) ---------------------------
masterdata_participant_round <- masterdata_participant  %>%
pivot_longer(
cols = contains("_round"),
names_to = c(".value", "round"),
names_sep = "_") %>%
filter(!participation == 0) %>%
mutate(round = as.numeric(str_sub(round, 6, 6))) %>%
left_join(monitoring_assign, by = c("round", "aula", "monitoreo"))
# Join teacher and monitor data to dataset at the participant level
teacher_monitor_data <- masterdata_participant_round %>%
group_by(nrodocumento) %>%
summarise(
ratio_teacher_female = sum(teacher_female) / n(),
ratio_female_monit = sum(monitor_female, na.rm = TRUE) / n())
masterdata_participant <- masterdata_participant %>%
left_join(teacher_monitor_data, by = "nrodocumento")
# Create master dataset (expediente level) -------------------------------
reportes <- reportes %>%
distinct() %>%
mutate(
juez = str_replace_all(juez, "\\(\\*\\)", ""),
juez = str_replace_all(juez, "\\,", ""),
juez = str_replace_all(juez, "\\([^()]{0,}\\)", ""),
# Replace trailing whitespace and special characters
juez = str_replace(juez, "^\\s", ""),
juez = str_replace_all(juez, "\\,", ""),
juez = str_replace(juez, "\\.$", ""),
juez = str_replace(juez, " \\- JUZ$", ""),
juez = str_replace(juez, "\\*", ""),
# Replace others
juez = str_replace(juez, "\\- MIXTO Y LIQ", ""),
juez = str_replace(juez, "\\- MIXTO", ""),
juez = str_replace(juez, "\\- JUZ\\. MIXTO", ""),
juez = str_replace(juez, "- JM", ""),
juez = str_replace(juez, "- INVESTIGACION", ""),
juez = str_replace(juez, "- PAZ LETRADO", ""),
juez = str_replace(juez, "SECOM - ", ""),
juez = str_replace(juez, "- JT", ""),
# Replace points
juez = str_replace(juez, "ALFREDO E\\.", "ALFREDO E"),
juez = str_replace(juez, "BERTHA F\\.", "BERTHA F"),
juez = str_replace(juez, "CLAUDIO W\\.", "CLAUDIO W"),
juez = str_replace(juez, "CLAVELITO L\\.", "CLAVELITO L"),
juez = str_replace(juez, "ELMER L\\.", "ELMER L"),
juez = str_replace(juez, "ERNESTO A\\.", "ERNESTO A"),
juez = str_replace(juez, "HERBERT M\\.", "HERBERT M"),
juez = str_replace(juez, "LUZ K\\.", "LUZ K"),
juez = str_replace(juez, "NANCY S\\.", "NANCY S"),
juez = str_replace(juez, "JESSICA E\\.", "JESSICA E"),
juez = str_replace(juez, "PATRICIA C\\.", "PATRICIA C"),
juez = str_replace(juez, "JESSICA P\\.", "JESSICA P"),
juez = str_replace(juez, "YOLANDA B\\.", "YOLANDA B"),
juez = str_replace(juez, "LUZ M\\.", "LUZ M"),
juez = str_replace(juez, "EDGAR\\.", "EDGAR"),
juez = str_replace(juez, "C\\. ARTURO", "C ARTURO"),
juez = str_replace(juez, "ALEXANDER A\\.", "ALEXANDER A"),
juez = str_replace(juez, "RENE G\\.", "RENE G"),
juez = str_replace(juez, "GUILLERMO S\\.", "GUILLERMO S"),
juez = str_replace(juez, "FANNY L\\. ", "FANNY L"),
juez = str_replace(juez, "ELISA \\(LA", "ELISA"),
juez = str_replace(juez, "JULIA \\(LA", "JULIA"),
juez = str_replace(juez, "ACEVEDO DIEZ CECILIA", "ACEVEDO DIEZ CECILIA DEL PILAR"),
# Remove whitespace
juez = str_squish(juez)) %>%
replace_na(list(juez = "<NO DEFINIDO>")) %>%
select(expediente_n, juez)
# Create dataset with all judge names
judge_names <- reportes %>%
group_by(juez) %>%
summarise(juez = first(juez)) %>%
mutate(
# Create number of judges per case
n_judges_case = str_count(juez, pattern = "\\.") + 1)
# Create dataset for cases with multiple judges
multiple_judge_names <- judge_names %>%
filter(!n_judges_case == 1) %>%
separate(juez,
c("juez1", "juez2", "juez3", "juez4", "juez5", "juez6"),
sep = "\\.",
remove = FALSE) %>%
mutate(across(starts_with("juez"), ~ifelse(is.na(.x),"\\-",.x)))
# Perform fuzzy join to match participants
# Try apellido-nombre
matched_judge_name1 <- masterdata_participant %>%
select(participant_apellido_nombre, nrodocumento) %>%
stringdist_left_join(judge_names,
by = c("participant_apellido_nombre" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
# Try nombre-apellido
matched_judge_name2 <- masterdata_participant %>%
select(participant_nombre_apellido, nrodocumento) %>%
stringdist_left_join(judge_names, "lv", 2,
by = c("participant_nombre_apellido" = "juez")) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
# Try apellido nombre for multiple judges
matched_judge_name3 <- masterdata_participant %>%
select(participant_nombre_apellido, nrodocumento) %>%
stringdist_left_join(multiple_judge_names,
by = c("participant_nombre_apellido" = "juez3"), method = "lv", max_dist = 2) %>%
filter(!is.na(juez))  %>%
select(nrodocumento, juez)
matched_judge_name4 <- masterdata_participant %>%
select(participant_apellido_nombre, nrodocumento) %>%
stringdist_left_join(multiple_judge_names,
by = c("participant_apellido_nombre" = "juez3"), method = "lv", max_dist = 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
# Join  datasets
matched_judge_name <- matched_judge_name1 %>%
bind_rows(matched_judge_name2) %>%
bind_rows(matched_judge_name3) %>%
bind_rows(matched_judge_name4)
# Create dataset with all cases managed by an AMAG-II Judges
masterdata_case_id <- matched_judge_name %>%
left_join(judge_names, by = "juez") %>%
left_join(masterdata_participant, by = "nrodocumento")
# Create new identifiers for each person and case-id
masterdata_participant <- masterdata_participant %>%
arrange(nrodocumento) %>%
rowid_to_column("participant_id")
masterdata_participant_round <- masterdata_participant %>%
select(nrodocumento, participant_id) %>%
left_join(masterdata_participant_round, by = "nrodocumento")
masterdata_case_id <- masterdata_participant %>%
select(nrodocumento, participant_id) %>%
inner_join(masterdata_case_id, by = "nrodocumento") %>%
arrange(nrodocumento, expediente_n) %>%
rowid_to_column("case_id")
# Load List of AMAG-II Judges
amag_ii_judges <- read_excel(
paste0('C:/Users/brend/OneDrive/Documents/GitHub/peru-amag-stats/',
'amag_ii_judges_list.xlsx'))
# Load List of AMAG-II Judges
amag_ii_judges <- read_csv(
paste0('C:/Users/brend/OneDrive/Documents/GitHub/peru-amag-stats/',
'amag_ii_judges_list.csv'))
View(amag_ii_judges)
View(amag_ii_judges)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
select(participant_apellido_nombre, nrodocumento) %>%
stringdist_left_join(judge_names,
by = c("participant_apellido_nombre" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
# Try nombre-apellido
matched_judge_name2 <- amag_ii_judges %>%
stringdist_left_join(judge_names, "lv", 2,
by = c("juez" = "juez")) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
# Try apellido nombre for multiple judges
matched_judge_name3 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2) %>%
filter(!is.na(juez))  %>%
select(nrodocumento, juez)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na('juez')) %>%
select(nrodocumento, juez)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
matched_judge_name4 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("participant_apellido_nombre" = "juez3"), method = "lv", max_dist = 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
matched_judge_name4 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
View(amag_ii_judges)
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
View(matched_judge_name1)
View(matched_judge_name1)
View(matched_judge_name3)
View(matched_judge_name4)
# Join  datasets
matched_judge_name <- matched_judge_name1 %>%
bind_rows(matched_judge_name2) %>%
bind_rows(matched_judge_name3) %>%
bind_rows(matched_judge_name4)
View(matched_judge_name)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
rlang::last_error()
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
View(judge_names)
# Try nombre-apellido
matched_judge_name2 <- amag_ii_judges %>%
stringdist_left_join(judge_names, "lv", 2,
by = c("juez" = "juez")) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
View(amag_ii_judges)
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
select(nrodocumento, juez)
# Perform fuzzy join to match participants
colnames(amag_ii_judges)
View(amag_ii_judges)
judge_names)
# Perform fuzzy join to match participants
colnames(judge_names)
# Perform fuzzy join to match participants
colnames(amag_ii_judges)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
dplyr::filter(!is.na(juez)) %>%
select(nrodocumento, juez)
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
dplyr::filter(!is.na(juez)) %>%
select(nrodocumento, juez)
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2)
# Try nombre-apellido
matched_judge_name2 <- amag_ii_judges %>%
stringdist_left_join(judge_names, "lv", 2,
by = c("juez" = "juez"))
# Try apellido nombre for multiple judges
matched_judge_name3 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2)
matched_judge_name4 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2)
View(matched_judge_name)
View(matched_judge_name1)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez.y)) %>%
select(nrodocumento, juez)
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez.y)) %>%
select(nrodocumento, juez.x)
# Try nombre-apellido
matched_judge_name2 <- amag_ii_judges %>%
stringdist_left_join(judge_names, "lv", 2,
by = c("juez" = "juez")) %>%
dplyr::filter(!is.na(juez.y)) %>%
select(nrodocumento, juez.x)
# Try apellido nombre for multiple judges
matched_judge_name3 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2) %>%
dplyr::filter(!is.na(juez.y))  %>%
select(nrodocumento, juez.x)
matched_judge_name4 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2) %>%
dplyr::filter(!is.na(juez.y)) %>%
select(nrodocumento, juez.x)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by =  'juez', "lv", 2) %>%
filter(!is.na(juez.y)) %>%
select(nrodocumento, juez.x)
# Try apellido-nombre
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by =  'juez', "lv", 2) %>%
filter(!is.na(juez)) %>%
select(nrodocumento, juez)
matched_judge_name1 <- amag_ii_judges %>%
stringdist_left_join(judge_names,
by = c("juez" = "juez"), "lv", 2) %>%
filter(!is.na(juez.y)) %>%
select(nrodocumento, juez.x)
# Try nombre-apellido
matched_judge_name2 <- amag_ii_judges %>%
stringdist_left_join(judge_names, "lv", 2,
by = c("juez" = "juez")) %>%
dplyr::filter(!is.na(juez.y)) %>%
select(nrodocumento, juez.x)
# Try apellido nombre for multiple judges
matched_judge_name3 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2) %>%
dplyr::filter(!is.na(juez.y))  %>%
select(nrodocumento, juez.x)
matched_judge_name4 <- amag_ii_judges %>%
stringdist_left_join(multiple_judge_names,
by = c("juez" = "juez3"), method = "lv", max_dist = 2) %>%
dplyr::filter(!is.na(juez.y)) %>%
select(nrodocumento, juez.x)
View(matched_judge_name1)
matched_judge_name <- matched_judge_name1 %>%
bind_rows(matched_judge_name2) %>%
bind_rows(matched_judge_name3) %>%
bind_rows(matched_judge_name4)
# Create dataset with all cases managed by an AMAG-II Judges
masterdata_case_id <- matched_judge_name %>%
left_join(judge_names, by = "juez") %>%
left_join(masterdata_participant, by = "nrodocumento")
# Create dataset with all cases managed by an AMAG-II Judges
masterdata_case_id <- matched_judge_name %>%
left_join(judge_names, by = "juez.x") %>%
left_join(masterdata_participant, by = "nrodocumento")
View(matched_judge_name)
# Create dataset with all cases managed by an AMAG-II Judges
masterdata_case_id <- matched_judge_name %>%
left_join(judge_names, by = "juez.x") %>%
left_join(amag_ii_judges, by = "nrodocumento")
View(judge_names)
# Create dataset with all cases managed by an AMAG-II Judges
masterdata_case_id <- matched_judge_name %>%
left_join(judge_names, by = "juez") %>%
left_join(amag_ii_judges, by = "nrodocumento")
View(matched_judge_name)
View(matched_judge_name3)
View(matched_judge_name)
View(judge_names)
# Create dataset with all cases managed by an AMAG-II Judges
masterdata_case_id <- matched_judge_name %>%
left_join(judge_names, by = c("juez.x" = "juez")) %>%
left_join(amag_ii_judges, by = "nrodocumento")
View(masterdata_case_id)
# Create dataset with all cases managed by an AMAG-II Judges
masterdata_case_id <- matched_judge_name %>%
left_join(judge_names, by = c("juez.x" = "juez")) %>%
left_join(amag_ii_judges, by = "nrodocumento") %>%
select(-'juez.x')
View(masterdata_case_id)
masterdata_participant <- masterdata_participant %>%
arrange(nrodocumento) %>%
rowid_to_column("participant_id")
masterdata_participant <- masterdata_participant %>%
arrange(nrodocumento) %>%
rowid_to_column("participant_id")
View(masterdata_participant)
masterdata_case_id <- masterdata_participant %>%
select(nrodocumento, participant_id) %>%
inner_join(masterdata_case_id, by = "nrodocumento") %>%
arrange(nrodocumento, expediente_n) %>%
rowid_to_column("case_id")
View(masterdata_case_id)
View(amag_ii_judges)
amag_ii_judges %>% distinct()
# Save master dataset - case id.
write_csv(masterdata_case_id,
paste0(local_storage,
"master_dataset_case_id_identified.csv"))
